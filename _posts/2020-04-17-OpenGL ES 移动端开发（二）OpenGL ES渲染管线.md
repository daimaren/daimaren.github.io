---
layout:     post
title:      OpenGL ES 移动端开发（二）OpenGL ES渲染管线
subtitle:   
date:       2020-04-17
author:     Glen
header-img: img/post-bg-none.jpg
catalog: true
tags:
    - OpenGL ES
    - Android
---

​    要想学习着色器，并理解着色器的工作机制，就要对OpenGL固定的渲染管线有深入的了解。我们首先介绍下常用术语。

- 几何图元：包括点、直线、三角形，均是通过顶点（vertex）来指定

的。

- 模型：根据几何图元创建的物体。
- 渲染：计算机根据模型创建图像的过程。

​    最终渲染过程结束之后，人眼所看到的图像就是由屏幕上的所有像素点组成的，在内存中，这些像素点可以组织成一个大的一维数组，每4个Byte即表示一个像素点的RGBA数据，而在显卡中，这些像素点可以组织成帧缓冲区（FrameBuffer）的形式，帧缓冲区保存了图形硬件为了控制屏幕上所有像素的颜色和强度所需要的全部信息。理解了帧缓冲区的概念，接下来就来讨论一下OpenGL的渲染管线，这部分内容对于OpenGL来说是非常重要的。

​    那么OpenGL的渲染管线具体是做什么的呢？其实就是OpenGL引擎渲染图像的流程，也就是说OpenGL引擎是一步一步地将图片渲染到屏幕上去的过程。道染管线分为以下几个阶段。

​    **阶段一：指定几何对象**

​    所谓几何对象，就是上面说过的几何图元，这里将根据具体执行的指令绘制几何图元。比如， OpenGL提供给开发者的绘制方法glDrawArrays，这个方法里面的第一个参数是mode，就是指定绘制方式，可选值有以下几种。

- GL_POINTS：以点的形式进行绘制，通常用在绘制粒子效果的场景

中

- GL_LINES：以线的形式进行绘制，通常用在绘制直线的场景中。
- GL_TRIANGLE_STRIP：以三角形的形式进行绘制，所有二维图像的渲

染都会使用这种方式。

​    具体选用哪一种绘制方式决定了OpenGL渲染管线的第一阶段应如何去绘制几何图元，所以这就是第一阶段指定的几何对象。

​    **阶段二：顶点处理**

​    不论以上的几何对象是如何指定的，所有的几何数据都将会经过这个阶段。这个阶段所做的操作就是，根据模型视图和投影矩阵进行变换来改变顶点的位置，根据纹理坐标与纹理矩阵来改变纹理坐标的位置，如果涉及三维的渲染，那么这里还要处理光照计算和法线变换。这里的输出是以gl_Position来表示具体的顶点位置的，如果是以点（GL_POINTS ）来绘制几何图元，那么还应该输出gl_PointSize。

​    **阶段三：图元组装**

在经过阶段二的顶点处理操作之后，不论是模型的顶点，还是纹理坐标都是已经确定好了的。在这个阶段，顶点将会根据应用程序送往图元的规则（如GL_POINTS, GL_TRIANGLES等），将纹理组装成图元。

​    **阶段四：栅格化操作**

​    由阶段三传递过来的图元数据，在此将会被分解成更小的单元并对应于帧缓冲区的各个像素。这些单元称为片元，一个片元可能包含窗口颜色、纹理坐标等属性。片元的属性是根据顶点坐标利用插值来确定的，这其实就是栅格化操作，也就是确定好每一个片元是什么。

​    **阶段五：片元处理**

​    通过纹理坐标取得纹理（texture）中相对应的片元像素值（pixel），根据自己的业务处理（比如提亮、饱和度调节、对比度调节、高斯模糊等）来变换这个片元的颜色。这里的输出是gl_FragColor，用于表示修改之后的像素的最终结果。

​    **阶段六：帧缓冲操作**

该阶段主要执行帧缓冲的写入操作，这也是渲染管线的最后一步，负责将最终的像素值写到帧缓冲区中。前面也提到过，OpenGL ES 2.0版本与之前的版本相比，更出色的功能就是提供了可编程的着色器来代替OpenGL ES中渲染管线的某一阶段。那么具体是哪一个着色器，又可以替换渲染管线的哪一个阶段呢？具体如下所示。

- Vertex Shader（顶点着色器）用来替换顶点处理阶段。
- Fragment Shader（片元着色器，又称像素着色器）用来替换片元处理阶段。